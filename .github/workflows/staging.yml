name: Staging

on:
  push:
    branches:
      - develop

jobs:

  build-upload:
    name: Build and upload
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup variables
      id: vars
      run: |
        echo "::set-output name=yarn-cache-path::$(yarn cache dir)"
        echo "::set-output name=composer-cache-path::$(composer config cache-files-dir)"
    - name: Setup Composer auth
      run: |
        echo '${{ secrets.COMPOSER_AUTH_JSON }}' > $(composer config data-dir)/auth.json
    - name: Cache Composer
      uses: actions/cache@v1
      with:
        path: ${{ steps.vars.outputs.composer-cache-path }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: ${{ runner.os }}-composer-
    - name: Cache Yarn
      uses: actions/cache@v1
      with:
        path: ${{ steps.vars.outputs.yarn-cache-path }}
        key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
        restore-keys: ${{ runner.os }}-yarn-
    - name: Install environment Composer dependencies
      run: composer install -o --no-progress
    - name: Install theme Composer dependencies
      run: |
        cd web/app/themes/wpadminref
        composer install -o --no-progress
    - name: Install theme Node dependencies
      run: |
        cd web/app/themes/wpadminref
        yarn install --no-progress
    - name: Upload files
      uses: Pendect/action-rsyncer@v1.1.0
      env:
        DEPLOY_KEY: ${{ secrets.SERVER_DEPLOY_KEY }}
      with:
        flags: '-avCh'
        options: '--delete-after --exclude-from=".deploy-excludes"'
        src: '.'
        dest: ${{ secrets.STAGING_RSYNC_URL }}